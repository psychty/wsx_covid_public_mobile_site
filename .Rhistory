write_lines(paste0(output_directory_x,'/ltla_summary.json'))
ltla_boundaries <- geojson_read('https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson',  what = "sp")
#download.file('https://opendata.arcgis.com/datasets/3a4fa2ce68f642e399b4de07643eeed3_0.geojson', paste0(github_repo_dir, '/Source files/failsafe_ltla_boundary.geojson'), mode = 'wb')
if(exists('ltla_boundaries') == FALSE) {
ltla_boundaries <- geojson_read(paste0(github_repo_dir, '/Source files/failsafe_ltla_boundary.geojson'),  what = "sp")
}
# utla_restrictions_geojson <-geojson_read("https://opendata.arcgis.com/datasets/b216b4c8a4e74f6fb692a1785255d777_0.geojson",  what = "sp") %>%
#   filter(substr(ctyua19cd, 1,1 ) == 'E') %>%
#   mutate(ctyua19nm = ifelse(ctyua19nm %in% c('Cornwall', 'Isles of Scilly'), 'Cornwall and Isles of Scilly', ifelse(ctyua19nm %in% c('City of London', 'Hackney'), 'Hackney and City of London', ctyua19nm))) %>%
#   mutate(ctyua19cd = ifelse(ctyua19cd %in% c('E06000053', 'E06000052'), 'E06000052', ifelse(ctyua19cd %in% c('E09000001', 'E09000012'), 'E09000012', ctyua19cd))) %>%
#   group_by(ctyua19cd, ctyua19nm) %>%
#   summarise() %>%
#   arrange(ctyua19cd) %>%
#   left_join(utla_summary, by = c('ctyua19nm' = 'Name'))
# geojson_write(geojson_json(utla_restrictions_geojson), file = paste0(output_directory_x, '/utla_covid_latest.geojson'))
ltla_restrictions_geojson <- ltla_boundaries %>%
filter(lad19cd %in% ltla_summary$`Area code`) %>%
arrange(lad19nm)
ltla_summary <- ltla_summary %>%
arrange(Name)
#left_join(ltla_summary, by = c('lad19nm' = 'Name'))
df <- data.frame(ID = character())
# Get the IDs of spatial polygon
for (i in ltla_restrictions_geojson@polygons ) { df <- rbind(df, data.frame(ID = i@ID, stringsAsFactors = FALSE))  }
# and set rowname = ID
row.names(ltla_summary) <- df$ID
# Then use df as the second argument to the spatial dataframe conversion function:
ltla_restrictions_geojson <- SpatialPolygonsDataFrame(ltla_restrictions_geojson, ltla_summary)
geojson_write(geojson_json(ltla_restrictions_geojson), file = paste0(output_directory_x, '/ltla_covid_latest.geojson'))
# Positivity and tests ####
positivity_ltla <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=ltla&metric=uniquePeopleTestedBySpecimenDateRollingSum&metric=uniqueCasePositivityBySpecimenDateRollingSum&metric=newLFDTests&format=csv') %>%
filter(substr(areaCode, 1,1) == 'E') %>%
select(-areaType) %>%
rename(Name = areaName,
Code = areaCode,
Date = date)
positivity_utla <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=utla&metric=uniquePeopleTestedBySpecimenDateRollingSum&metric=uniqueCasePositivityBySpecimenDateRollingSum&metric=newLFDTests&&format=csv') %>%
filter(substr(areaCode, 1,1) == 'E') %>%
select(-areaType) %>%
rename(Name = areaName,
Code = areaCode,
Date = date)
positivity_region <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=region&metric=uniquePeopleTestedBySpecimenDateRollingSum&metric=uniqueCasePositivityBySpecimenDateRollingSum&metric=newLFDTests&&format=csv') %>%
filter(substr(areaCode, 1,1) == 'E') %>%
select(-areaType) %>%
rename(Name = areaName,
Code = areaCode,
Date = date)
positivity_nation <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&metric=uniquePeopleTestedBySpecimenDateRollingSum&metric=uniqueCasePositivityBySpecimenDateRollingSum&metric=newLFDTests&&format=csv') %>%
filter(substr(areaCode, 1,1) == 'E') %>%
select(-areaType) %>%
rename(Name = areaName,
Code = areaCode,
Date = date)
positivity_df <- positivity_ltla %>%
bind_rows(positivity_utla) %>%
bind_rows(positivity_region) %>%
bind_rows(positivity_nation) %>%
unique() %>%
filter(Name %in% c('Adur', 'Arun', 'Chichester', 'Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East', 'England')) %>%
mutate(Name = ifelse(Name == 'South East', 'South East region', Name)) %>%
group_by(Name) %>%
arrange(Name, Date) %>%
mutate(LFD_7_day_tests = rollapplyr(newLFDTests, 7, sum , align = 'right', partial = TRUE)) %>%
mutate(Date_label = format(Date, '%d %b %y'))
positivity_df %>%
filter(Date == complete_date) %>%
mutate(uniquePeopleTestedBySpecimenDateRollingSum = format(uniquePeopleTestedBySpecimenDateRollingSum, big.mark = ',', trim = TRUE)) %>%
mutate(uniqueCasePositivityBySpecimenDateRollingSum = paste0(uniqueCasePositivityBySpecimenDateRollingSum, '%')) %>%
mutate(LFD_7_day_tests = format(LFD_7_day_tests, big.mark = ',')) %>%
select(Name, uniquePeopleTestedBySpecimenDateRollingSum, uniqueCasePositivityBySpecimenDateRollingSum, LFD_7_day_tests) %>%
mutate(Name = factor(Name, levels = c('Adur', 'Arun', 'Chichester', 'Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East region', 'England'))) %>%
arrange(Name) %>%
toJSON() %>%
write_lines(paste0(output_directory_x,'/positivity_at_a_glance.json'))
# Polymerase chain reaction (PCR) tests are lab-based and test for the presence of SARS-CoV-2 virus. This data shows the number of people who received a PCR test in the previous 7 days, and the percentage of people who received a PCR test in the previous 7 days who had at least one positive PCR test result.
# If a person has had more than one test result in the 7-day period, they are only counted once. If any of their tests in that period were positive, they count as one person with a positive test result. The positivity percentage is the number of people with a positive test result, divided by the number of people tested and multiplied by 100.
# Individuals tested more than once in the period are only counted once in the denominator, and those with more than one positive test result in the period are only included once in the numerator.
Areas <- c('Adur', 'Arun', 'Chichester','Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East region', 'England')
Dates <- seq.Date(min(positivity_df$Date), max(positivity_df$Date), by = '1 day')
positivity_worked_raw <- data.frame(Name = character(), Date = character())
for(i in 1:length(Areas)){
area_x = Areas[i]
df_x <- data.frame(Name = rep(area_x, length(Dates))) %>%
mutate(Date = seq.Date(min(positivity_df$Date), max(positivity_df$Date), by = '1 day')) %>%
mutate(Date = as.character(Date)) %>%
ungroup()
positivity_worked_raw <- positivity_worked_raw %>%
bind_rows(df_x)
}
positivity_df_raw <- positivity_df %>%
mutate(Date = as.character(Date))
positivity_worked <- positivity_worked_raw %>%
left_join(positivity_df_raw, by = c('Name', 'Date')) %>%
arrange(Date, Name) %>%
mutate(uniquePeopleTestedBySpecimenDateRollingSum = replace_na(uniquePeopleTestedBySpecimenDateRollingSum, 0)) %>%
rename(Seven_day_PCR_positivity = uniqueCasePositivityBySpecimenDateRollingSum,
Seven_day_PCR_tested_individuals = uniquePeopleTestedBySpecimenDateRollingSum) %>%
mutate(Perc_change_on_individuals_tested = round((Seven_day_PCR_tested_individuals - lag(Seven_day_PCR_tested_individuals, 7))/ lag(Seven_day_PCR_tested_individuals, 7), 2))  %>%
mutate(Perc_change_on_individuals_tested = ifelse(Perc_change_on_individuals_tested == Inf, 1, Perc_change_on_individuals_tested)) %>%
mutate(Perc_change_on_lfd_tests = round((LFD_7_day_tests - lag(LFD_7_day_tests, 7))/ lag(LFD_7_day_tests, 7), 2))  %>%
mutate(Perc_change_on_lfd_tests = ifelse(Perc_change_on_lfd_tests == Inf, 1, Perc_change_on_lfd_tests)) %>%
mutate(Perc_change_on_individuals_tested = replace_na(Perc_change_on_individuals_tested, 0)) %>%
mutate(Perc_change_on_lfd_tests = replace_na(Perc_change_on_lfd_tests, 0)) %>%
mutate(Name = factor(Name, levels = c('Adur', 'Arun', 'Chichester', 'Crawley', 'Horsham', 'Mid Sussex', 'Worthing', 'West Sussex', 'South East region', 'England'))) %>%
arrange(Name, Date) %>%
mutate(Date = as.Date(Date)) %>%
mutate(Date_label = format(Date, '%d %b %y'))
positivity_worked %>%
# filter(Date <= complete_date) %>%
select(!c(Date, Code)) %>%
mutate(LFD_7_day_tests = replace_na(LFD_7_day_tests, 0)) %>%
mutate(Seven_day_PCR_positivity = Seven_day_PCR_positivity/100) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/positivity_df.json'))
positivity_worked <- positivity_worked %>%
ungroup() %>%
mutate(Date = as.Date(Date))
positivity_worked %>%
#  filter(Date <= complete_date) %>%
filter(Date %in% seq.Date(max(Date) -(52*7), max(Date), by = 7)| Date == min(Date)) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
select(Date_label) %>%
unique() %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/test_dates.json'))
library(lemon)
data_dummy_positivity_worked <- positivity_worked %>%
rename(dummy_name = Name)
positivity_worked_plotted <- ggplot(positivity_worked,
aes(x = Date,
y = Seven_day_PCR_positivity,
colour = Name)) +
geom_line(data = data_dummy_positivity_worked,
aes(x = Date,
y = Seven_day_PCR_positivity,
group = dummy_name),
colour = '#dbdbdb',
size = .6) +
geom_line(size = .9) +
geom_point(size = .5) +
ph_theme() +
theme(axis.text.x = element_text(angle = 90, size = 6),
legend.position = 'none') +
scale_y_continuous(labels = label_comma(accuracy = 1, suffix = '%'),
limits = c(0,40),
breaks = seq(0, 40, 5)) +
scale_x_date(date_labels = "%b %d",
breaks = seq.Date(complete_date -(52*7), complete_date, by = 7),
limits = c(min(positivity_worked$Date), complete_date),
expand = c(0.01,1)) +
labs(x = '',
y = '7-day rolling PCR case positivity rate',
title = paste0('7-day PCR Case positivity rate for Covid-19 in the last 90 days; West Sussex, South East region, and England'),
subtitle = paste0('Pillar 1 and 2 combined; data as at ', format(last_date, '%d %B %Y')))  +
theme(axis.text.x = element_text(size = 8)) +
facet_rep_wrap(. ~ Name, ncol = 4, repeat.tick.labels = TRUE)
png(paste0(output_directory_x, '/Figure_7_day_rolling_positivity_rates_latest_faceted.png'),
width = 1480,
height = 880,
res = 130)
print(positivity_worked_plotted)
dev.off()
# Hospital admissions ####
if(!file.exists(paste0(github_repo_dir, '/Source files/etr.csv'))){
download.file('https://files.digital.nhs.uk/assets/ods/current/etr.zip', paste0(github_repo_dir, '/Source files/etr.zip'), mode = 'wb')
unzip(paste0(github_repo_dir, '/Source files/etr.zip'), exdir = github_repo_dir)
file.remove(paste0(github_repo_dir, '/Source files/etr.zip'), paste0(github_repo_dir, '/Source files/etr.pdf'))
}
calls_hosp_webpage <- read_html('https://www.england.nhs.uk/statistics/statistical-work-areas/covid-19-hospital-activity/') %>%
html_nodes("a") %>%
html_attr("href")
download.file(grep('Weekly-covid', calls_hosp_webpage, value = T), paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'), mode = 'wb')
trust_admission_date <- read_excel( paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
sheet = 'All beds COVID',
skip = 2,
col_names = FALSE,
n_max = 5) %>%
rename(Item = ...1,
Description = ...2) %>%
filter(Item == 'Published:') %>%
mutate(Description  = as.Date(as.numeric(Description), origin = "1899-12-30"))
admissions_df_trust <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=nhsTrust&metric=newAdmissions&metric=hospitalCases&metric=covidOccupiedMVBeds&format=csv')
admissions_df_region <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=nhsRegion&metric=newAdmissions&metric=hospitalCases&metric=covidOccupiedMVBeds&format=csv')
admissions_df_nation <- read_csv('https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&metric=newAdmissions&metric=hospitalCases&metric=covidOccupiedMVBeds&format=csv')
# We need to use data.gov to get cumulative admissions because the NHS digital data only starts on August 1st
admissions_df <- admissions_df_trust %>%
bind_rows(admissions_df_region) %>%
bind_rows(admissions_df_nation) %>%
rename(Name = areaName,
Admissions_or_new_cases_in_last_24hrs = newAdmissions,
Patients_occupying_beds = hospitalCases,
Patients_occupying_mv_beds = covidOccupiedMVBeds,
Date = date) %>%
mutate(Admissions_or_new_cases_in_last_24hrs = replace_na(Admissions_or_new_cases_in_last_24hrs, 0),
Patients_occupying_beds = replace_na(Patients_occupying_beds, 0),
Patients_occupying_mv_beds = replace_na(Patients_occupying_mv_beds, 0)) %>%
mutate(Patients_occupying_non_mv_beds = Patients_occupying_beds - Patients_occupying_mv_beds) %>%
select(Name, Date, Admissions_or_new_cases_in_last_24hrs, Patients_occupying_beds, Patients_occupying_mv_beds, Patients_occupying_non_mv_beds) %>%
group_by(Name) %>%
arrange(Name, Date) %>%
mutate(Rolling_7_day_admissions = rollapply(Admissions_or_new_cases_in_last_24hrs, 7, sum, align = 'right', fill = NA),
Rolling_average_7_day_admissions = rollapply(Admissions_or_new_cases_in_last_24hrs, 7, mean, align = 'right', fill = NA),
Total_admissions = cumsum(Admissions_or_new_cases_in_last_24hrs)) %>%
filter(Name %in%  c('Brighton and Sussex University Hospitals NHS Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Sussex Partnership NHS Foundation Trust', 'Western Sussex Hospitals NHS Foundation Trust', 'South East', 'England')) %>%
mutate(Name = factor(Name, levels = c('Brighton and Sussex University Hospitals NHS Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Sussex Partnership NHS Foundation Trust','Western Sussex Hospitals NHS Foundation Trust', 'South East', 'England'))) %>%
arrange(Name) %>%
ungroup() %>%
add_row(Name = 'Sussex Community NHS Foundation Trust', Date = as.Date('2020-03-19'), Admissions_or_new_cases_in_last_24hrs = NA, Patients_occupying_beds = NA, Patients_occupying_mv_beds = NA, Patients_occupying_non_mv_beds = NA, Rolling_7_day_admissions = NA, Rolling_average_7_day_admissions = NA, Total_admissions = NA) %>%
add_row(Name = 'Sussex Community NHS Foundation Trust', Date = as.Date('2020-03-20'), Admissions_or_new_cases_in_last_24hrs = NA, Patients_occupying_beds = NA, Patients_occupying_mv_beds = NA, Patients_occupying_non_mv_beds = NA, Rolling_7_day_admissions = NA, Rolling_average_7_day_admissions = NA, Total_admissions = NA)
# patients occupying beds as at 8am
admissions_date <- admissions_df_trust %>%
filter(!is.na(newAdmissions)) %>%
filter(date == max(date, na.rm = TRUE)) %>%
select(date) %>%
unique() %>%
mutate(item = 'Admissions')
occupied_date <- admissions_df_trust %>%
filter(!is.na(hospitalCases)) %>%
filter(date == max(date, na.rm = TRUE)) %>%
select(date) %>%
unique() %>%
mutate(item = 'Patients in hospital')
publish_date <- data.frame(date = trust_admission_date$Description,
item = 'Publish date')
admissions_date %>%
bind_rows(occupied_date) %>%
bind_rows(publish_date) %>%
mutate(Date_label = format(date, '%A %d %B %Y')) %>%
toJSON() %>%
write_lines(paste0(output_directory_x,'/hospital_meta.json'))
data.frame(Date = seq.Date(admissions_date$date -(52*7), admissions_date$date, by = 7)) %>%
filter(Date >= min(admissions_df$Date)) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/admission_date_labels.json'))
hospital_table_a <- admissions_df %>%
filter(Date == admissions_date$date) %>%
select(Name, Admissions_or_new_cases_in_last_24hrs, Rolling_7_day_admissions, Total_admissions)
hospital_table_b <- admissions_df %>%
filter(Date == occupied_date$date) %>%
select(Name, Patients_occupying_beds, Patients_occupying_mv_beds)
hospital_table <- hospital_table_a %>%
left_join(hospital_table_b, by = 'Name')
hospital_table %>%
select(!Admissions_or_new_cases_in_last_24hrs) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/latest_hospital_summary.json'))
admissions_export_df <- admissions_df %>%
filter(Date <= admissions_date$date) %>%
select(Name, Date, Admissions_or_new_cases_in_last_24hrs, Rolling_average_7_day_admissions, Rolling_7_day_admissions, Total_admissions) %>%
group_by(Name) %>%
arrange(Name, Date) %>%
mutate(Previous_Rolling_7_day_admissions = lag(Rolling_7_day_admissions, 7)) %>%
mutate(Perc_change_rolling_7_day_admissions = (Rolling_7_day_admissions - lag(Rolling_7_day_admissions, 7))/ lag(Admissions_or_new_cases_in_last_24hrs, 7)) %>%
mutate(Perc_change_rolling_7_day_admissions = ifelse(Perc_change_rolling_7_day_admissions == Inf, 1,Perc_change_rolling_7_day_admissions)) %>%
mutate(Perc_change_rolling_7_day_admissions = replace_na(Perc_change_rolling_7_day_admissions, 0)) %>%
mutate(Perc_change_rolling_7_day_admissions = ifelse(Perc_change_rolling_7_day_admissions <0, 'Down', ifelse(Perc_change_rolling_7_day_admissions == 0, 'Same', ifelse(Perc_change_rolling_7_day_admissions > 0, 'Up', NA)))) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
select(!Date)
admissions_export_df %>%
toJSON() %>%
write_lines(paste0(output_directory_x,'/admissions_export_df.json'))
# admissions_export_df %>% view()
beds_occupied_export_df <- admissions_df %>%
select(Name, Date, Patients_occupying_beds, Patients_occupying_mv_beds, Patients_occupying_non_mv_beds) %>%
group_by(Name) %>%
arrange(Name, Date) %>%
mutate(Previous_occupying_beds = lag(Patients_occupying_beds, 7)) %>%
mutate(Perc_change_on_beds_occupied = (Patients_occupying_beds - lag(Patients_occupying_beds, 7))/ lag(Patients_occupying_beds, 7)) %>%
mutate(Perc_change_on_beds_occupied = ifelse(Perc_change_on_beds_occupied == Inf, 1, Perc_change_on_beds_occupied)) %>%
mutate(Perc_change_on_beds_occupied = replace_na(Perc_change_on_beds_occupied, 0)) %>%
mutate(Change_direction = ifelse(Perc_change_on_beds_occupied <0, 'decreased', ifelse(Perc_change_on_beds_occupied == 0, 'stayed the same', ifelse(Perc_change_on_beds_occupied > 0, 'increased', NA)))) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
filter(Date <= occupied_date$date) %>%
select(!c(Date))
data.frame(Date = seq.Date(occupied_date$date -(52*7), occupied_date$date, by = 7)) %>%
filter(Date >= min(admissions_df$Date)) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/occupied_date_labels.json'))
beds_occupied_export_df %>%
toJSON() %>%
write_lines(paste0(output_directory_x,'/beds_occupied_export_df.json'))
# trust_admissions_1 <- read_excel( paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
#                                   sheet = 'Hosp ads & diag',
#                                   skip = 13) %>%
#   filter(!is.na(Name)) %>%
#   mutate(Name = capwords(Name, strict = TRUE)) %>%
#   mutate(Name = gsub('Nhs', 'NHS', Name)) %>%
#   mutate(Name = gsub(' And ', ' and ', Name)) %>%
#   mutate(Name = gsub('Cic', 'CIC', Name)) %>%
#   mutate(Name = gsub('C.i.c', 'C.I.C', Name)) %>%
#   pivot_longer(names_to = 'Date', values_to = 'Admissions_or_new_cases_in_last_24hrs', cols = 5:ncol(.)) %>%
#   mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30"))  %>%
#   filter(Name %in% c('England', 'South East', 'Western Sussex Hospitals NHS Foundation Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Brighton and Sussex University Hospitals NHS Trust')) %>%
#   select(!c('Type 1 Acute?', 'NHS England Region', 'Code')) %>%
#   mutate(Source_of_admission = 'All')
#
# trust_admissions_1_ch <- read_excel(paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
#                                      sheet = 'Care home ads and diags',
#                                      skip = 13) %>%
#   filter(!is.na(Name)) %>%
#   mutate(Name = capwords(Name, strict = TRUE)) %>%
#   mutate(Name = gsub('Nhs', 'NHS', Name)) %>%
#   mutate(Name = gsub(' And ', ' and ', Name)) %>%
#   mutate(Name = gsub('Cic', 'CIC', Name)) %>%
#   mutate(Name = gsub('C.i.c', 'C.I.C', Name)) %>%
#   pivot_longer(names_to = 'Date', values_to = 'Admissions_or_new_cases_in_last_24hrs', cols = 5:ncol(.)) %>%
#   mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30"))  %>%
#   filter(Name %in% c('England', 'South East', 'Western Sussex Hospitals NHS Foundation Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Brighton and Sussex University Hospitals NHS Trust')) %>%
#   select(!c('Type 1 Acute?', 'NHS England Region', 'Code')) %>%
#   mutate(Source_of_admission = 'Care home')
#
# admissions_source_df <- trust_admissions_1 %>%
#   bind_rows(trust_admissions_1_ch) %>%
#   pivot_wider(names_from = Source_of_admission, values_from = Admissions_or_new_cases_in_last_24hrs) %>%
#   mutate(All = replace_na(All, 0),
#          `Care home` = replace_na(`Care home`, 0)) %>%
#   mutate(`Not care home` = All - `Care home`) %>%
#   select(!All) %>%
#   pivot_longer(cols = c(`Not care home`, `Care home`), names_to = 'Source_of_admission',  values_to = 'Admissions_or_new_cases_in_last_24hrs') %>%
#   mutate(Source_of_admission = factor(Source_of_admission, levels = c('Care home', 'Not care home'))) %>%
#   group_by(Name, Source_of_admission) %>%
#   arrange(Name, Source_of_admission, Date) %>%
#   mutate(Rolling_7_day_admissions = rollapply(Admissions_or_new_cases_in_last_24hrs, 7, sum, align = 'right', fill = NA),
#          Total_admissions = cumsum(Admissions_or_new_cases_in_last_24hrs))
#trust_x <- 'England'
#admissions_x_df <- admissions_df %>%
# filter(Name == trust_x)
# ggplot(admissions_x_df,
#        aes(x = Date,
#            y = Admissions_or_new_cases_in_last_24hrs)) +
#   geom_bar(stat = 'identity',
#            width = .9,
#            fill = '#901020') +
#   geom_line(aes(x = Date,
#                 group = 1,
#                 y = Rolling_average_7_day_admissions),
#             colour = '#000000',
#             lwd = 1.2) +
#   scale_x_date(date_labels = "%d %b %y",
#                breaks = seq.Date(admissions_date$date -(52*7), admissions_date$date, by = 7),
#                expand = c(0,0.01)) +
#   scale_y_continuous(expand = c(0,0.01)) +
#   labs(x = 'Date',
#        y = 'Number of admissions',
#        title = paste0('Number of new admissions with a positive COVID-19 test result; ',trust_x),
#        subtitle = paste0('New admissions or inpatients with a new diagnosis; data up to ', format(admissions_date$date, '%d %B %Y'), ' as at ', format(trust_admission_date$Description, '%d %B %Y'))) +
#   ph_theme() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
#
# ggplot(admissions_x_df,
#        aes(x = Date,
#            y = Rolling_7_day_admissions)) +
#   geom_line(group = 1,
#             colour = '#901020') +
#   scale_x_date(date_labels = "%b %d",
#                breaks = seq.Date(admissions_date$date -(52*7), admissions_date$date, by = 7),
#                expand = c(0.01,0.01)) +
#   labs(x = 'Date',
#        y = 'Rolling 7 day admissions',
#        title = paste0('Rolling 7 day number of new admissions with a positive COVID-19 test result; ',trust_x),
#        subtitle = paste0('New admissions or inpatients with a new diagnosis; data up to ', format(admissions_date$date, '%d %B %Y'), ' as at ', format(trust_admission_date$Description, '%d %B %Y'))) +
#   ph_theme() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
#
# patients_in_beds_df <- admissions_df %>%
#   select(Name, Date, Patients_occupying_mv_beds, Patients_occupying_non_mv_beds) %>%
#   filter(Date <= occupied_date$date) %>%
#   pivot_longer(cols = c(Patients_occupying_non_mv_beds, Patients_occupying_mv_beds), names_to = 'Bed_type', values_to = 'Patients_occupying_beds') %>%
#   mutate(Bed_type = ifelse(Bed_type == 'Patients_occupying_mv_beds', 'Mechanical ventilation', ifelse(Bed_type == 'Patients_occupying_non_mv_beds', 'Not capable of mechanical ventilation', NA)))
#patients_in_beds_df_x <- patients_in_beds_df %>%
#  filter(Name == trust_x)
# ggplot(patients_in_beds_df_x,
#        aes(x = Date,
#            y = Patients_occupying_beds)) +
#   geom_bar(stat = 'identity',
#            colour = '#ffffff',
#            aes(fill = Bed_type)) +
#   scale_x_date(date_labels = "%b %d",
#                breaks = seq.Date(admissions_date$date -(52*7), admissions_date$date, by = 7),
#                expand = c(0.01,0.01)) +
#   scale_fill_manual(values = c('#006900', '#669900'),
#                     name = 'Bed type') +
#   labs(x = 'Date',
#        y = 'Number of inpatients',
#        title = paste0('Number of patients in hospital with positive COVID-19 test result; ',trust_x),
#        subtitle = paste0('Data up to ', format(admissions_date$date, '%d %B %Y'), ' as at ', format(trust_admission_date$Description, '%d %B %Y'))) +
#   ph_theme() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
# Share of inpatient beds occupied ####
trust_c19_patients_occupying_ga_beds <- read_excel( paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
sheet = 'Adult G&A Beds Occupied COVID',
skip = 13) %>%
filter(!is.na(Name)) %>%
mutate(Name = capwords(Name, strict = TRUE)) %>%
mutate(Name = gsub('Nhs', 'NHS', Name)) %>%
mutate(Name = gsub(' And ', ' and ', Name)) %>%
mutate(Name = gsub('Cic', 'CIC', Name)) %>%
mutate(Name = gsub('C.i.c', 'C.I.C', Name)) %>%
pivot_longer(names_to = 'Date', values_to = 'c19_patients_occupying_ga_beds', cols = 5:ncol(.)) %>%
mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30")) %>%
filter(Name %in% c('England', 'South East', 'Western Sussex Hospitals NHS Foundation Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Sussex Partnership NHS Foundation Trust', 'Brighton and Sussex University Hospitals NHS Trust')) %>%
select(!c('Type 1 Acute?', 'NHS England Region', 'Code'))
trust_other_patients_occupying_ga_beds <- read_excel( paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
sheet = 'Adult G&A Bed Occupied NonCOVID',
skip = 13) %>%
filter(!is.na(Name)) %>%
mutate(Name = capwords(Name, strict = TRUE)) %>%
mutate(Name = gsub('Nhs', 'NHS', Name)) %>%
mutate(Name = gsub(' And ', ' and ', Name)) %>%
mutate(Name = gsub('Cic', 'CIC', Name)) %>%
mutate(Name = gsub('C.i.c', 'C.I.C', Name)) %>%
pivot_longer(names_to = 'Date', values_to = 'other_patients_occupying_ga_beds', cols = 5:ncol(.)) %>%
mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30")) %>%
filter(Name %in% c('England', 'South East', 'Western Sussex Hospitals NHS Foundation Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust',  'Sussex Partnership NHS Foundation Trust','Brighton and Sussex University Hospitals NHS Trust')) %>%
select(!c('Type 1 Acute?', 'NHS England Region', 'Code'))
trust_vacant_ga_beds <- read_excel( paste0(github_repo_dir,'/Source files/trust_admissions.xlsx'),
sheet = 'Adult G&A Beds Unoccupied',
skip = 13) %>%
filter(!is.na(Name)) %>%
mutate(Name = capwords(Name, strict = TRUE)) %>%
mutate(Name = gsub('Nhs', 'NHS', Name)) %>%
mutate(Name = gsub(' And ', ' and ', Name)) %>%
mutate(Name = gsub('Cic', 'CIC', Name)) %>%
mutate(Name = gsub('C.i.c', 'C.I.C', Name)) %>%
pivot_longer(names_to = 'Date', values_to = 'vacant_ga_beds', cols = 5:ncol(.)) %>%
mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30")) %>%
filter(Name %in% c('England', 'South East', 'Western Sussex Hospitals NHS Foundation Trust', 'Surrey and Sussex Healthcare NHS Trust', 'Sussex Community NHS Foundation Trust', 'Sussex Partnership NHS Foundation Trust', 'Brighton and Sussex University Hospitals NHS Trust')) %>%
select(!c('Type 1 Acute?', 'NHS England Region', 'Code'))
bed_used_df <- trust_c19_patients_occupying_ga_beds %>%
left_join(trust_other_patients_occupying_ga_beds, by = c('Name', 'Date')) %>%
left_join(trust_vacant_ga_beds, by = c('Name', 'Date')) %>%
pivot_longer(cols = c(c19_patients_occupying_ga_beds, other_patients_occupying_ga_beds, vacant_ga_beds), names_to = 'Bed_status', values_to = 'Beds') %>%
group_by(Name, Date) %>%
mutate(Total_open_beds = sum(Beds),
Proportion = Beds/sum(Beds)) %>%
mutate(Bed_status = factor(ifelse(Bed_status == 'c19_patients_occupying_ga_beds', 'COVID-19 + patients', ifelse(Bed_status == 'other_patients_occupying_ga_beds', 'Other patients', ifelse(Bed_status == 'vacant_ga_beds', 'Vacant (open) beds', NA))), levels = c('COVID-19 + patients', 'Other patients', 'Vacant (open) beds')))
unique(bed_used_df$Name)
# trust_admissions_metadata <- read_excel( paste0(github_repo_dir,'/Source_files/trust_admissions.xlsx'),
#                                          sheet = 'All beds COVID',
#                                          skip = 2,
#                                          col_names = FALSE,
#                                          n_max = 5) %>%
#   rename(Item = ...1,
#          Description = ...2) %>%
#   mutate(Description = ifelse(Item == 'Published:', as.character(format(as.Date(as.numeric(Description), origin = "1899-12-30"), '%d-%b-%Y')), Description))
# beds_used_df_x <- bed_used_df %>%
#   filter(Name == trust_x)
# ggplot(beds_used_df_x,
#        aes(x = Date,
#            y = Proportion)) +
#   geom_bar(stat = 'identity',
#            position = position_fill(reverse = TRUE),
#            colour = '#ffffff',
#            aes(fill = Bed_status)) +
#   scale_x_date(date_labels = "%b %d",
#                breaks = seq.Date(max(bed_used_df$Date) -(52*7), max(bed_used_df$Date), by = 7),
#                expand = c(0.01,0.01)) +
#   scale_fill_manual(values = c('#12263a', '#c96480', '#abcdef')) +
#   scale_y_continuous(limits = c(0,1),
#                      breaks = seq(0,1, .1),
#                      labels = percent_format(accuracy = 1)) +
#   labs(x = 'Date',
#        y = 'Proportion',
#        title = paste0('Proportion of patients occupying adult beds; ', trust_x),
#        subtitle = paste0('Share of all adult general and acute beds (%); data available from ',  format(min(bed_used_df$Date), '%d %B %Y'), ' up to ', format(max(bed_used_df$Date), '%d %B %Y'), ' as at ', format(trust_admission_date$Description, '%d %B %Y')),
#        caption = 'This measure only includes adult inpatient beds. It is estimated that adult beds comprised more than 99% of inpatient beds in NHS hospital trusts.') +
#   ph_theme() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
bed_used_df_export_1 <- bed_used_df %>%
mutate(Bed_status = ifelse(Bed_status == 'COVID-19 + patients', 'covid_19_patients', ifelse(Bed_status == 'Other patients', 'other', ifelse(Bed_status == 'Vacant (open) beds', 'vacant', NA)))) %>%
select(!c(Proportion, Total_open_beds)) %>%
pivot_wider(names_from = 'Bed_status', values_from = 'Beds') %>%
mutate(Total_open_beds = covid_19_patients + other + vacant) %>%
mutate(Label = paste0('As at 8:00am on ', ordinal(as.numeric(format(Date, '%d'))), format(Date, ' %B %Y'), ' there were ', format(covid_19_patients, big.mark = ','), ' patients in adult General and Acute inpatient beds, this is ', round((covid_19_patients / Total_open_beds)*100, 1), '% of the total number of open beds on this day.'))
bed_used_df_export <- bed_used_df %>%
mutate(Bed_status = ifelse(Bed_status == 'COVID-19 + patients', 'covid_19_patients', ifelse(Bed_status == 'Other patients', 'other', ifelse(Bed_status == 'Vacant (open) beds', 'vacant', NA)))) %>%
select(!c(Beds, Total_open_beds)) %>%
pivot_wider(names_from = 'Bed_status', values_from = 'Proportion') %>%
left_join(bed_used_df_export_1[c('Name', 'Date', 'Label')], by = c('Name', 'Date')) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
ungroup()
bed_used_df_export %>%
select(!Date) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/patient_share_occupied_beds.json'))
data.frame(Date = seq.Date(max(bed_used_df_export$Date) -(52*7), max(bed_used_df_export$Date), by = 7)) %>%
filter(Date >= min(bed_used_df_export$Date)) %>%
mutate(Date_label = format(Date, '%d %b %y')) %>%
toJSON() %>%
write_lines(paste0(output_directory_x, '/bed_share_ga_date_labels.json'))
# ggplot(beds_used_df_x,
#        aes(x = Date,
#            y = Beds)) +
#   geom_bar(stat = 'identity',
#            colour = '#ffffff',
#            aes(fill = Bed_status)) +
#   scale_x_date(date_labels = "%b %d",
#                breaks = seq.Date(max(bed_used_df$Date) -(52*7), max(bed_used_df$Date), by = 7),
#                expand = c(0.01,0.01)) +
#   scale_fill_manual(values = c('#12263a', '#c96480', '#abcdef')) +
#   labs(x = 'Date',
#        y = 'Number of beds',
#        title = paste0('Number of patients occupying adult beds in NHS hospital trusts'),
#        subtitle = paste0('Share of all adult general and acute beds (%); data up to ', format(max(bed_used_df$Date), '%d %B %Y'), ' as at ', format(trust_admission_date$Description, '%d %B %Y')),
#        caption = 'This measure only includes adult inpatient beds. It is estimated that adult beds comprised more than 99% of inpatient beds in NHS hospital trusts.') +
#   ph_theme() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
# STP/ICS vaccine counts ####
# https://www.england.nhs.uk/statistics/statistical-work-areas/covid-19-vaccinations/
